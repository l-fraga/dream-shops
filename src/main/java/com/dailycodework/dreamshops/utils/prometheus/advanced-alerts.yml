# ========================================
# ALERTAS AVAN√áADOS - STATUS DIN√ÇMICO
# ========================================
# Vers√£o avan√ßada dos alertas com informa√ß√µes din√¢micas baseadas em recording rules

groups:
  - name: dreamshops_advanced_alerts
    rules:
      # ========================================
      # ALERTAS DE STATUS DIN√ÇMICO
      # ========================================
      
      # Aplica√ß√£o DOWN - com tempo din√¢mico
      - alert: ApplicationDownAdvanced
        expr: |
          dreamshops:application_status == 0
        for: 1m
        labels:
          severity: critical
          service: dreamshops
          alert_type: "status_change"
        annotations:
          summary: "üö® {{ $labels.job }} est√° FORA DO AR h√° {{ $value | humanizeDuration }}"
          description: |
            A aplica√ß√£o {{ $labels.job }} n√£o est√° respondendo.
            Tempo offline: {{ $value | humanizeDuration }}
            √öltima verifica√ß√£o: {{ $labels.instance }}
            Status: CR√çTICO

      # Aplica√ß√£o UP - notifica√ß√£o de recupera√ß√£o
      - alert: ApplicationUpAdvanced
        expr: |
          dreamshops:application_status == 1
        for: 30s
        labels:
          severity: info
          service: dreamshops
          alert_type: "status_change"
        annotations:
          summary: "‚úÖ {{ $labels.job }} est√° NO AR e funcionando"
          description: |
            A aplica√ß√£o {{ $labels.job }} est√° operacional.
            Status: SAUD√ÅVEL
            √öltima verifica√ß√£o: {{ $labels.instance }}

      # Aplica√ß√£o inst√°vel - alternando entre up/down
      - alert: ApplicationUnstable
        expr: |
          changes(dreamshops:application_status[5m]) > 3
        for: 2m
        labels:
          severity: warning
          service: dreamshops
          alert_type: "instability"
        annotations:
          summary: "‚ö†Ô∏è {{ $labels.job }} est√° INST√ÅVEL - alternando status"
          description: |
            A aplica√ß√£o {{ $labels.job }} est√° alternando entre online/offline.
            Mudan√ßas nos √∫ltimos 5 minutos: {{ $value }}
            Status: INST√ÅVEL

      # ========================================
      # ALERTAS DE PERFORMANCE DIN√ÇMICOS
      # ========================================
      
      # Tempo de resposta alto - com contexto
      - alert: HighResponseTimeAdvanced
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_server_requests_seconds_bucket[5m])) by (job, le)
          ) > 2
        for: 3m
        labels:
          severity: warning
          service: dreamshops
          alert_type: "performance"
        annotations:
          summary: "üêå {{ $labels.job }} est√° LENTO - {{ $value }}s (95th percentile)"
          description: |
            Performance degradada detectada em {{ $labels.job }}.
            Tempo de resposta 95th percentile: {{ $value }}s
            Threshold: 2s
            Status: ATEN√á√ÉO

      # Taxa de erro alta - com percentual
      - alert: HighErrorRateAdvanced
        expr: |
          sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (job)
          > 0.1
        for: 2m
        labels:
          severity: critical
          service: dreamshops
          alert_type: "errors"
        annotations:
          summary: "üí• {{ $labels.job }} com MUITOS ERROS - {{ $value | humanizePercentage }}"
          description: |
            Taxa de erro alta detectada em {{ $labels.job }}.
            Erros por segundo: {{ $value }}
            Percentual de erros: {{ $value | humanizePercentage }}
            Status: CR√çTICO

      # ========================================
      # ALERTAS DE SISTEMA DIN√ÇMICOS
      # ========================================
      
      # CPU alto - com contexto de aplica√ß√£o
      - alert: HighCPUUsageAdvanced
        expr: |
          100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
          alert_type: "resource"
        annotations:
          summary: "üî• CPU ALTO em {{ $labels.instance }} - {{ $value | humanizePercentage }}"
          description: |
            Uso de CPU elevado detectado.
            CPU atual: {{ $value | humanizePercentage }}
            Inst√¢ncia: {{ $labels.instance }}
            Threshold: 80%
            Status: ATEN√á√ÉO

      # Mem√≥ria baixa - com contexto
      - alert: LowMemoryAdvanced
        expr: |
          ((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * 100 > 90
        for: 5m
        labels:
          severity: warning
          service: system
          alert_type: "resource"
        annotations:
          summary: "üíæ MEM√ìRIA BAIXA em {{ $labels.instance }} - {{ $value | humanizePercentage }}"
          description: |
            Uso de mem√≥ria cr√≠tico detectado.
            Mem√≥ria utilizada: {{ $value | humanizePercentage }}
            Inst√¢ncia: {{ $labels.instance }}
            Threshold: 90%
            Status: ATEN√á√ÉO

      # ========================================
      # ALERTAS DE BANCO DIN√ÇMICOS
      # ========================================
      
      # Conex√µes de banco altas - com contexto
      - alert: HighDatabaseConnectionsAdvanced
        expr: |
          (hikaricp_connections_active / hikaricp_connections_max) * 100 > 80
        for: 2m
        labels:
          severity: warning
          service: postgres
          alert_type: "database"
        annotations:
          summary: "üóÑÔ∏è CONEX√ïES DE BANCO ALTAS - {{ $value | humanizePercentage }}"
          description: |
            Pool de conex√µes do banco de dados est√° alto.
            Conex√µes ativas: {{ $value | humanizePercentage }}
            Threshold: 80%
            Status: ATEN√á√ÉO

      # ========================================
      # ALERTAS DE NEG√ìCIO DIN√ÇMICOS
      # ========================================
      
      # Falhas em pedidos - com contexto
      - alert: OrderCreationFailureAdvanced
        expr: |
          sum(rate(http_server_requests_seconds_count{uri="/api/v1/orders",status=~"5.."}[5m])) by (job)
          > 0.05
        for: 2m
        labels:
          severity: critical
          service: dreamshops
          alert_type: "business"
        annotations:
          summary: "üõí FALHAS EM PEDIDOS em {{ $labels.job }} - {{ $value | humanizePercentage }}"
          description: |
            Falhas na cria√ß√£o de pedidos detectadas.
            Taxa de falha: {{ $value | humanizePercentage }}
            Endpoint: /api/v1/orders
            Status: CR√çTICO - IMPACTO NO NEG√ìCIO

      # Falhas em pagamentos - com contexto
      - alert: PaymentFailureAdvanced
        expr: |
          sum(rate(http_server_requests_seconds_count{uri="/api/v1/payments",status=~"5.."}[5m])) by (job)
          > 0.1
        for: 2m
        labels:
          severity: critical
          service: dreamshops
          alert_type: "business"
        annotations:
          summary: "üí≥ FALHAS EM PAGAMENTOS em {{ $labels.job }} - {{ $value | humanizePercentage }}"
          description: |
            Falhas em pagamentos detectadas.
            Taxa de falha: {{ $value | humanizePercentage }}
            Endpoint: /api/v1/payments
            Status: CR√çTICO - IMPACTO FINANCEIRO

      # ========================================
      # ALERTAS DE SEGURAN√áA DIN√ÇMICOS
      # ========================================
      
      # Tentativas de for√ßa bruta - com contexto
      - alert: BruteForceAttemptAdvanced
        expr: |
          sum(rate(http_server_requests_seconds_count{uri="/api/v1/auth/login"}[5m])) by (job)
          > 10
        for: 1m
        labels:
          severity: warning
          service: dreamshops
          alert_type: "security"
        annotations:
          summary: "üîí POSS√çVEL FOR√áA BRUTA em {{ $labels.job }} - {{ $value }} req/min"
          description: |
            Muitas tentativas de login detectadas.
            Tentativas por minuto: {{ $value }}
            Endpoint: /api/v1/auth/login
            Status: ATEN√á√ÉO - POSS√çVEL ATAQUE

      # Acessos n√£o autorizados - com contexto
      - alert: UnauthorizedAccessAdvanced
        expr: |
          sum(rate(http_server_requests_seconds_count{status="401"}[5m])) by (job)
          > 5
        for: 2m
        labels:
          severity: warning
          service: dreamshops
          alert_type: "security"
        annotations:
          summary: "üö´ ACESSOS N√ÉO AUTORIZADOS em {{ $labels.job }} - {{ $value }} req/min"
          description: |
            Muitos acessos n√£o autorizados detectados.
            Acessos 401 por minuto: {{ $value }}
            Status: ATEN√á√ÉO - POSS√çVEL BREACH 